<%= link_to event_path(@event), class: 'back-link' do %>
  <i class="far fa-arrow-alt-circle-left"></i> Назад
<% end %>

<div class="title-container with-bottom-border">
  <h1 class="title"><%= @event.name %> (итоги)</h1>
</div>
<% cols = []
   rows = []
  @results.each do |result|
    if result['spent'] > result['debt']
      cols << result
    else
      rows << result
    end
  end %>

<div class="result-container">
<table class="result">
  <tr>
    <th rowspan="2">Кто переводит</th>
    <th colspan=<%= cols.length %>>
      Кому переводят
    </th>
  </tr>
  <tr>
    <% cols.each do |col| %>
      <% col['need_money'] = col['spent'] - col['debt'] %>
      <td><%= col['user'].username %></td>
    <% end %>
  </tr>

  <% rows.each do |row| %>
    <% debug = {} %>
    <% current_debt = row['debt'] - row['spent'] %>
    <tr>
      <td>
        <%= row['user'].username %>
      </td>
      <% cols.each do |col| %>
        <td>
          <% if current_debt == 0 %>
            0
          <% elsif col['need_money'] == 0%>
            0
          <% elsif current_debt <= col['need_money'] %>
            <%= number_to_currency(current_debt, unit: 'руб.', format: "%n %u") %>
            <% col['need_money'] = col['need_money'] - current_debt %>
            <% current_debt = 0 %>
          <% else %>
            <%= number_to_currency(col['need_money'], unit: 'руб.', format: "%n %u") %>
            <% current_debt = current_debt - col['need_money'] %>
            <% col['need_money'] = 0 %>
          <% end %>
        </td>
      <% end %>
    </tr>
  <% end %>
</table>
</div>
